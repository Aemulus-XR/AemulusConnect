<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  <!--
    AemulusConnect Application Installer
    This WiX installer creates an MSI package for the AemulusConnect Application
  -->

  <?define ProductName = "AemulusConnect" ?>
  <?define ProductVersion = "2.4.3.0" ?>
  <?define Manufacturer = "Aemulus XR" ?>
  <?define UpgradeCode = "8b7c49af-4352-4886-a835-dd52f7b44131" ?>

  <!-- Build output path - passed from build script or defaults to framework-dependent -->
  <?ifndef BuildOutputPath ?>
    <?define BuildOutputPath = "..\bin\Release\net8.0-windows10.0.26100.0" ?>
  <?endif ?>

  <!-- TODO: Generate a unique GUID for UpgradeCode using: powershell -Command "[guid]::NewGuid()" -->
  <!-- Keep the same UpgradeCode for all versions to enable upgrades -->

  <Package
    Name="$(var.ProductName)"
    Version="$(var.ProductVersion)"
    Manufacturer="$(var.Manufacturer)"
    UpgradeCode="$(var.UpgradeCode)"
    Language="1033"
    Compressed="yes"
    InstallerVersion="500"
    Scope="perMachine">

    <SummaryInformation
      Keywords="Installer"
      Description="$(var.ProductName) Installer"
      Manufacturer="$(var.Manufacturer)" />

    <!-- Major upgrade configuration - allows newer versions to replace older ones -->
    <MajorUpgrade
      DowngradeErrorMessage="A newer version of [ProductName] is already installed."
      AllowSameVersionUpgrades="yes" />

    <!-- Embed the cab file in the MSI -->
    <MediaTemplate EmbedCab="yes" />

    <!-- Check for .NET 8.0 or higher Desktop Runtime -->
    <Launch
      Message="This application requires .NET 8.0 Desktop Runtime or later. Please install it from https://dotnet.microsoft.com/download/dotnet/8.0"
      Condition="DOTNETDESKTOPINSTALLED OR Installed" />

    <!-- Custom property to check for .NET Desktop Runtime -->
    <!-- Looks for the Microsoft.WindowsDesktop.App folder which exists if any Desktop Runtime is installed -->
    <Property Id="DOTNETDESKTOPINSTALLED">
      <DirectorySearch Id="SearchDotNetDesktop" Path="C:\Program Files\dotnet\shared\Microsoft.WindowsDesktop.App" />
    </Property>

    <!-- Custom action for finish dialog -->
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch AemulusConnect" />

    <!-- Launch application -->
    <CustomAction
      Id="LaunchApplication"
      Directory="BINFOLDER"
      ExeCommand="[BINFOLDER]AemulusConnect.exe"
      Execute="immediate"
      Impersonate="yes"
      Return="asyncNoWait" />

    <!-- Installation directory structure -->
    <StandardDirectory Id="ProgramFiles6432Folder">
      <Directory Id="ManufacturerFolder" Name="$(var.Manufacturer)">
        <Directory Id="INSTALLFOLDER" Name="$(var.ProductName)">
          <Directory Id="BINFOLDER" Name="bin">
            <Directory Id="PlatformToolsFolder" Name="platform-tools" />
            <!-- Localization culture folders -->
            <Directory Id="Culture_arSA" Name="ar-SA" />
            <Directory Id="Culture_deDE" Name="de-DE" />
            <Directory Id="Culture_esES" Name="es-ES" />
            <Directory Id="Culture_frFR" Name="fr-FR" />
            <Directory Id="Culture_enPIRATE" Name="en-PIRATE" />
          </Directory>
          <Directory Id="DOCUMENTATIONFOLDER" Name="documentation" />
        </Directory>
      </Directory>
    </StandardDirectory>

    <!-- Start Menu folder -->
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="$(var.ProductName)" />
    </StandardDirectory>

    <!-- Desktop folder for shortcut (optional) -->
    <StandardDirectory Id="DesktopFolder" />

    <!-- Main application component -->
    <!-- All files mirror the Shipping/bin/ folder structure -->
    <ComponentGroup Id="ProductComponents" Directory="BINFOLDER">
      <Component Id="MainExecutable" Guid="d30b4069-00ca-424a-9e68-5b43fdfa7d74">
        <!-- Main executable -->
        <File Id="AemulusConnectExe" Source="$(var.BuildOutputPath)\bin\AemulusConnect.exe" KeyPath="yes" />

        <!-- Application DLLs and dependencies -->
        <File Source="$(var.BuildOutputPath)\bin\AemulusConnect.dll" />
        <File Source="$(var.BuildOutputPath)\bin\AdvancedSharpAdbClient.dll" />
        <File Source="$(var.BuildOutputPath)\bin\log4net.dll" />
        <File Source="$(var.BuildOutputPath)\bin\Microsoft.Windows.SDK.NET.dll" />
        <File Source="$(var.BuildOutputPath)\bin\WinRT.Runtime.dll" />

        <!-- Runtime configuration files -->
        <File Source="$(var.BuildOutputPath)\bin\AemulusConnect.runtimeconfig.json" />
        <File Source="$(var.BuildOutputPath)\bin\AemulusConnect.deps.json" />
        <File Source="$(var.BuildOutputPath)\bin\log4net.config" />
      </Component>

      <!-- ADB Platform Tools -->
      <Component Id="PlatformToolsComponent" Directory="PlatformToolsFolder" Guid="a48a76d8-f696-458e-a734-01ea103437f3">
        <File Source="$(var.BuildOutputPath)\bin\platform-tools\adb.exe" KeyPath="yes" />
        <File Source="$(var.BuildOutputPath)\bin\platform-tools\AdbWinApi.dll" />
      </Component>
    </ComponentGroup>

    <!-- Localization satellite assemblies -->
    <ComponentGroup Id="LocalizationComponents">
      <!-- Arabic (Saudi Arabia) -->
      <Component Id="Culture_arSA_Component" Directory="Culture_arSA" Guid="1a8f5c2b-9d3e-4f1a-8b7c-2d3e4f5a6b7c">
        <File Source="$(var.BuildOutputPath)\bin\ar-SA\AemulusConnect.resources.dll" KeyPath="yes" />
      </Component>

      <!-- German (Germany) -->
      <Component Id="Culture_deDE_Component" Directory="Culture_deDE" Guid="2b9f6d3c-0e4f-5a2b-9c8d-3e4f5a6b7c8d">
        <File Source="$(var.BuildOutputPath)\bin\de-DE\AemulusConnect.resources.dll" KeyPath="yes" />
      </Component>

      <!-- Spanish (Spain) -->
      <Component Id="Culture_esES_Component" Directory="Culture_esES" Guid="3c0a7e4d-1f5a-6b3c-0d9e-4f5a6b7c8d9e">
        <File Source="$(var.BuildOutputPath)\bin\es-ES\AemulusConnect.resources.dll" KeyPath="yes" />
      </Component>

      <!-- French (France) -->
      <Component Id="Culture_frFR_Component" Directory="Culture_frFR" Guid="4d1b8f5e-2a6b-7c4d-1e0f-5a6b7c8d9e0f">
        <File Source="$(var.BuildOutputPath)\bin\fr-FR\AemulusConnect.resources.dll" KeyPath="yes" />
      </Component>

      <!-- Pirate English (Custom) -->
      <Component Id="Culture_enPIRATE_Component" Directory="Culture_enPIRATE" Guid="5e2c9a6f-3b7c-8d5e-2f1a-6b7c8d9e0f1a">
        <File Source="$(var.BuildOutputPath)\bin\en-PIRATE\AemulusConnect.resources.dll" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Documentation component -->
    <ComponentGroup Id="DocumentationComponents" Directory="DOCUMENTATIONFOLDER">
      <Component Id="UserDocumentation" Guid="3cc6bcbf-51d9-4600-8e13-74bca12b9405">
        <!-- License RTF -->
        <File Id="LicenseRtf" Source="$(var.BuildOutputPath)\documentation\LICENSE.rtf" Name="License.rtf" KeyPath="yes" />

        <!-- User Guide PDF -->
        <File Id="UserGuidePdf" Source="$(var.BuildOutputPath)\documentation\USER_GUIDE.pdf" Name="UserGuide.pdf" />
      </Component>
    </ComponentGroup>

    <!-- Start Menu Shortcuts -->
    <ComponentGroup Id="ApplicationShortcuts" Directory="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="*">
        <Shortcut
          Id="ApplicationStartMenuShortcut"
          Name="$(var.ProductName)"
          Description="AemulusConnect Application"
          Target="[BINFOLDER]AemulusConnect.exe"
          WorkingDirectory="BINFOLDER"
          Icon="AppIcon.exe" />

        <!-- User Guide shortcut -->
        <Shortcut
          Id="UserGuideShortcut"
          Name="User Guide"
          Description="Open the AemulusConnect User Guide"
          Target="[DOCUMENTATIONFOLDER]UserGuide.pdf" />

        <!-- Uninstall shortcut -->
        <Shortcut
          Id="UninstallProduct"
          Name="Uninstall $(var.ProductName)"
          Description="Uninstalls $(var.ProductName)"
          Target="[System64Folder]msiexec.exe"
          Arguments="/x [ProductCode]" />

        <RemoveFolder
          Id="CleanUpStartMenu"
          Directory="ApplicationProgramsFolder"
          On="uninstall" />

        <RegistryValue
          Root="HKCU"
          Key="Software\$(var.Manufacturer)\$(var.ProductName)"
          Name="installed"
          Type="integer"
          Value="1"
          KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Optional: Desktop Shortcut -->
    <ComponentGroup Id="DesktopShortcuts" Directory="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="*">
        <Shortcut
          Id="ApplicationDesktopShortcut"
          Name="$(var.ProductName)"
          Description="AemulusConnect Application"
          Target="[BINFOLDER]AemulusConnect.exe"
          WorkingDirectory="BINFOLDER"
          Icon="AppIcon.exe" />

        <RemoveFile
          Id="CleanUpDesktopShortcut"
          Name="$(var.ProductName).lnk"
          On="uninstall" />

        <RegistryValue
          Root="HKCU"
          Key="Software\$(var.Manufacturer)\$(var.ProductName)"
          Name="desktopShortcut"
          Type="integer"
          Value="1"
          KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Icon definition -->
    <Icon Id="AppIcon.exe" SourceFile="..\aemulus.ico" />
    <Property Id="ARPPRODUCTICON" Value="AppIcon.exe" />

    <!-- Add/Remove Programs information -->
    <Property Id="ARPURLINFOABOUT" Value="https://www.aemulus-xr.com/" />
    <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />
    <Property Id="ARPNOMODIFY" Value="yes" Secure="yes" />

    <!-- Features to install -->
    <Feature
      Id="ProductFeature"
      Title="AemulusConnect Application"
      ConfigurableDirectory="INSTALLFOLDER"
      Level="1"
      Description="The main application files and Start Menu shortcuts">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="LocalizationComponents" />
      <ComponentGroupRef Id="DocumentationComponents" />
      <ComponentGroupRef Id="ApplicationShortcuts" />
    </Feature>

    <Feature
      Id="DesktopShortcutFeature"
      Title="Desktop Shortcut"
      Level="1"
      Description="Creates a shortcut on the desktop">
      <ComponentGroupRef Id="DesktopShortcuts" />
    </Feature>

    <!-- License file for installer dialog -->
    <WixVariable Id="WixUILicenseRtf" Value="$(var.BuildOutputPath)\documentation\LICENSE.rtf" />

    <!-- Custom branding images (optional - comment out if images don't exist) -->
    <!-- Banner: 493x58 pixels, shown at top of most dialogs -->
    <!-- <WixVariable Id="WixUIBannerBmp" Value="banner.bmp" /> -->

    <!-- Dialog: 493x312 pixels, shown on Welcome and Exit dialogs -->
    <!-- <WixVariable Id="WixUIDialogBmp" Value="dialog.bmp" /> -->

    <!-- Custom Installer UI using WiX 4 pattern -->
    <UI>
      <ui:WixUI Id="WixUI_FeatureTree" />
      <!-- Launch app when checkbox is checked -->
      <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="LaunchApplication" Condition="WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed" />
    </UI>

  </Package>
</Wix>
